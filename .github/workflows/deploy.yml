name: Deploy Sabina Akter Server

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  APP_NAME: sabina-akter
  APP_PORT: 3000
  DEPLOY_DIR: /var/www/sabina-akter

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0

      - name: Check Node Version
        run: |
          node -v
          npm -v

      - name: Install Dependencies
        run: npm install --frozen-lockfile

      - name: Build Next.js App
        run: npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Deploy via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_KEY_SABINA_PORTFOLIO }}
          EC2_HOST: ${{ secrets.HOST_SABINA_PORTFOLIO }}
          EC2_USER: ${{ secrets.USER_SABINA_PORTFOLIO }}
          DEPLOY_DIR: /var/www/sabina-akter
          APP_NAME: sabina-akter
        run: |
          # ---------------------------
          # Setup SSH
          # ---------------------------
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

          # ---------------------------
          # Install Node 22 & PM2 on Server
          # ---------------------------
          ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST "
            sudo apt update
            sudo apt install -y build-essential python3 curl
            curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
            sudo apt-get install -y nodejs
            sudo npm install -g pm2
          "

          # ---------------------------
          # Create deployment directory
          # ---------------------------
          ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST "
            sudo mkdir -p $DEPLOY_DIR
            sudo chown -R $EC2_USER:$EC2_USER $DEPLOY_DIR
          "

          # ---------------------------
          # Copy project files to server
          # ---------------------------
          rsync -avz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            -e 'ssh -i ~/.ssh/id_rsa' \
            . $EC2_USER@$EC2_HOST:$DEPLOY_DIR/

          # ---------------------------
          # Install dependencies, build
          # ---------------------------
          ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST "
            cd $DEPLOY_DIR
            npm install --legacy-peer-deps
            npm run build
          "

          # ---------------------------
          # Restart app with PM2
          # ---------------------------
          ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST "
            pm2 delete $APP_NAME || true
            cd $DEPLOY_DIR
            pm2 start npm --name $APP_NAME -- start
            pm2 save
          "
